<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>이글스 성과평가 단축키 입력 시스템 v3.6</title>
  <style>
    body { font-family: sans-serif; margin: 30px; }
    h1 { margin-bottom: 10px; }
    .lineup-input { margin-bottom: 20px; }
    .lineup-input input { margin: 2px; }
    .actions { margin: 6px 0; display:flex; gap:8px; }

    #stepProgress { margin: 12px 0 16px; display: flex; flex-wrap: wrap; gap: 8px; }
    .stepBox {
      padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc;
      background-color: #eee; font-weight: bold; font-size: 14px;
    }
    .stepBox.active { background-color: #007bff; color: #fff; border-color: #007bff; }

    #currentInputLine {
      font-size: 16px; margin-top: 10px; margin-bottom: 6px;
      font-weight: bold; color: #333;
    }
    #hint { font-size: 12px; color: #666; margin-bottom: 16px; }

    .log { margin-top: 24px; border-top: 1px solid #ccc; padding-top: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    .flash-bg { background-color: #cce5ff; transition: background-color 0.6s ease; }

    .topRow { display: flex; align-items: flex-start; gap: 16px; }

    #legendBox {
      flex: 0 0 300px; max-width: 300px;
      margin: 15px 0 8px 0; padding: 10px 15px;
      border: 1px solid #cfd8e3; background-color: #e9eef5;
      border-radius: 6px;
    }
    #legendBox strong { display:block; margin-bottom:4px; }
    #legendBox ul { list-style: none; padding-left: 0; margin: 6px 0 0; }
    #legendBox li { margin: 4px 0; }
    .red { color: red; font-weight: bold; }
    .green { color: green; font-weight: bold; }
    .yellow { color: #b8860b; font-weight: bold; }

    #lineupSummary {
      flex: 1 1 auto;
      border: 1px solid #ddd; background: #f9f9f9;
      padding: 12px; display: none;
    }
    #lineupSummary h3 { margin: 0 0 8px; }

    #lineupWrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .lineupPanel {
      border: 1px solid #e2e2e2; background: #fff;
      padding: 10px; min-width: 220px;
    }
    .lineupPanel h4 { margin: 0 0 6px; font-size: 14px; }
    .key { width: 28px; display: inline-block; color: #888; }
    #starterList > div, #benchList > div { border-bottom: 1px dashed #eee; padding: 2px 0; }

    .btn-danger { background:#dc3545; color:#fff; border:none; padding:6px 10px; cursor:pointer; }
    .btn { background:#eee; border:1px solid #ccc; padding:6px 10px; cursor:pointer; }

    /* 축약 배지 & 이닝 태그 */
    .miniPlay{
      margin-left:6px; padding:1px 6px; border-radius:9999px;
      background:#eef2f7; color:#333; font-size:12px; font-weight:600;
    }
    .inningTag{
      margin-left:8px; padding:2px 8px; border-radius:9999px;
      background:#e8f0ff; color:#1a4fb3; font-size:12px; font-weight:700;
    }

    /* 상단 일정명 입력 */
    .schedRow{ display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
    .schedRow input{ padding:6px 8px; border:1px solid #ccc; border-radius:4px;}
  </style>
</head>
<body>
  <h1>
    <img src="EG LOGO.png" alt="이글스 로고" style="width:50px;height:50px;vertical-align:middle;margin-right:8px;">
    이글스 성과평가 단축키 입력 시스템 <span style="font-size:.7em;color:#888;">v3.6</span>
  </h1>

  <!-- 라인업/일정명 입력 -->
  <div class="lineup-input" id="lineupInput">
    <div class="schedRow">
      <label for="scheduleName"><strong>일정명:</strong></label>
      <input id="scheduleName" placeholder="예) '25 호크스 리그경기 1" style="min-width:280px;">
    </div>

    <div><strong>선발 (1~9번):</strong></div>
    <div id="starterInputs"></div>
    <div style="margin-top:6px;"><strong>대기 (q~t):</strong></div>
    <div id="benchInputs"></div>
    <div class="actions" style="margin-top:8px;">
      <button id="applyLineupBtn" type="button" class="btn">라인업 적용</button>
    </div>
  </div>

  <!-- 진행 스텝 표시 -->
  <div id="stepProgress"></div>

  <div class="topRow">
    <div id="legendBox">
      <strong>선택지 (단축키 입력 가능):</strong>
      <ul id="legendList"></ul>
    </div>

    <div id="lineupSummary">
      <h3>라인업 <span id="currentInningTag" class="inningTag" style="display:none;"></span></h3>
      <div id="lineupWrapper">
        <div class="lineupPanel">
          <h4>선발 (1~9)</h4>
          <div id="starterList"></div>
        </div>
        <div class="lineupPanel">
          <h4>교체 (q~t)</h4>
          <div id="benchList"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="currentInputLine">[현재 입력 중] → </div>
  <div id="hint">ESC: 전체 초기화(스텝만) / Backspace: 한 단계 롤백</div>

  <!-- 로그 -->
  <div class="log">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:5px;">
      <h2 style="margin:0;">입력 로그</h2>
      <div class="actions">
        <button id="deleteSelected" class="btn">선택 삭제</button>
        <button id="exportCsv" class="btn">CSV 다운로드</button>
        <button id="resetAll" class="btn-danger" title="라인업/진행상태/로그 전체 삭제">전체 초기화</button>
      </div>
    </div>
    <table id="logTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>#</th>
          <th>이닝</th>
          <th>타순</th>
          <th>선수</th>
          <th>이벤트</th>
          <th>방향1</th>
          <th>방향2</th>
          <th>성격</th>
          <th>종류</th>
          <th>결과</th>
          <th>기록</th>
          <th>코드</th>
          <th>점수</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
window.CODE_RULES = [
  /* ===== 사사구/삼진 ===== */
  { code: "B-SO-O", score: -1.5, when: { event: "[삼진/사사구/기타 이벤트]", type: "[삼진]", result: "[아웃]" } },
  { code: "B-SO-S", score: 0,    when: { event: "[삼진/사사구/기타 이벤트]", type: "[삼진]", result: "[출루]" } },
  { code: "B-BB",   score: 1,    when: { event: "[삼진/사사구/기타 이벤트]", type: "[볼넷]", result: "[출루]" } },
  { code: "B-BB",   score: 1,    when: { event: "[삼진/사사구/기타 이벤트]", type: "[사구]", result: "[출루]" } },

  /* ===== 주루 ===== */
  { code: "BR-2ndQ", score: 1,   when: { event: "[주루 이벤트]", type: "[도루]", result: "[2루 도루 (2구 이내)]" } },
  { code: "BR-2nd",  score: 0.5, when: { event: "[주루 이벤트]", type: "[도루]", result: "[2루 도루 (3구 이상)]" } },
  { code: "BR-3rd",  score: 1,   when: { event: "[주루 이벤트]", type: "[도루]", result: "[3루 도루]" } },

  { code: "BR-ETB-1", score: 1,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[2루 ETB]" } },
  { code: "BR-ETB-1", score: 1,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[3루 ETB]" } },
  { code: "BR-ETB-2", score: 1.5, when: { event: "[주루 이벤트]", type: "[진루]", result: "[홈 ETB]" } },
  { code: "BR-WP",    score: 0,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[상대 폭투로 진루]" } },
  { code: "BR-FE",    score: 0,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[상대 실책으로 진루]" } },
  { code: "BR-SF",    score: 0,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[진루타로 진루]" } },

  { code: "BR-E-1", score: -1.5, when: { event: "[주루 이벤트]", type: "[아웃]", result: "[도루자/주루사 (2루)]" } },
  { code: "BR-E-1", score: -1.5, when: { event: "[주루 이벤트]", type: "[아웃]", result: "[도루자/주루사 (3루)]" } },
  { code: "BR-E-2", score: -2,   when: { event: "[주루 이벤트]", type: "[아웃]", result: "[도루자/주루사 (홈)]" } },

  { code: "BR-E-3", score: -1,   when: { event: "[주루 이벤트]", type: "[진루 기회 놓침]", result: "[진루 기회 놓침 (2루/3루)]" } },
  { code: "BR-E-5", score: -1.5, when: { event: "[주루 이벤트]", type: "[진루 기회 놓침]", result: "[진루 기회 놓침 (홈)]" } },
  { code: "BR-E-4", score: -0.5, when: { event: "[주루 이벤트]", type: "[진루 기회 놓침]", result: "[도루 기회 놓침]" } },

  { code: "BR-STP-S", score: 1,  when: { event: "[주루 이벤트]", type: "[주루 작전]", result: "[주루 작전 성공]" } },
  { code: "STP",      score: 0,  when: { event: "[주루 이벤트]", type: "[주루 작전]", result: "[주루 작전 실패]" } },

  /* ===== 타격(땅볼 계열) ===== */
  { code: "B-G-O",   score: -1,  when: { event: "[타격 이벤트]", type: "[아웃성]",     detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O",   score: -1,  when: { event: "[타격 이벤트]", type: "[아웃성]",     detail: "[땅볼]", result: "[선행주자 아웃]" } },

  { code: "B-G-O-H", score: 0,   when: { event: "[타격 이벤트]", type: "[1루타성]",   detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O-H", score: 0,   when: { event: "[타격 이벤트]", type: "[1루타성]",   detail: "[땅볼]", result: "[선행주자 아웃]" } },
  { code: "B-G-O-H", score: 0,   when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O-H", score: 0,   when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[선행주자 아웃]" } },

  { code: "B-G-S",   score: 0.5, when: { event: "[타격 이벤트]", type: "[병살타성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-O",   score: -1,  when: { event: "[타격 이벤트]", type: "[병살타성]", detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O",   score: -1,  when: { event: "[타격 이벤트]", type: "[병살타성]", detail: "[땅볼]", result: "[선행주자 아웃]" } },
  { code: "B-GD-O",  score: -2,  when: { event: "[타격 이벤트]", type: "[병살타성]", detail: "[땅볼]", result: "[더블 아웃]" } },

  { code: "B-G-S",   score: 0.5, when: { event: "[타격 이벤트]", type: "[아웃성]",     detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S",   score: 0.5, when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[출루]" } },

{ code: "B-G-S-H", score: 1, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]", dir1: "[투수]" } },
{ code: "B-G-S-H", score: 1, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]", dir1: "[포수]" } },
{ code: "B-G-S-H", score: 1, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]", dir1: "[1루수]" } },
{ code: "B-G-S-H", score: 1, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]", dir1: "[2루수]" } },
{ code: "B-G-S-H", score: 1, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]", dir1: "[3루수]" } },
{ code: "B-G-S-H", score: 1, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]", dir1: "[유격수]" } },


  /* ===== 타격(직선타 계열) ===== */
  { code: "B-L-O",   score: -1,  when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[타자 아웃]" } },
  { code: "B-L-O",   score: -1,  when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[선행주자 아웃]" } },

  { code: "B-L-O-H", score: 0,   when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[직선타]", result: "[타자 아웃]" } },
  { code: "B-L-O-H", score: 0,   when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[직선타]", result: "[선행주자 아웃]" } },

  { code: "B-L-S", score: 0.5, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[출루]" } },

{ code: "B-L-S-H", score: 1, when: { event: "[타격 이벤트]", dir1: "[투수]",   type: "[1루타성]", detail: "[직선타]", result: "[출루]" } },
{ code: "B-L-S-H", score: 1, when: { event: "[타격 이벤트]", dir1: "[포수]",   type: "[1루타성]", detail: "[직선타]", result: "[출루]" } },
{ code: "B-L-S-H", score: 1, when: { event: "[타격 이벤트]", dir1: "[1루수]",  type: "[1루타성]", detail: "[직선타]", result: "[출루]" } },
{ code: "B-L-S-H", score: 1, when: { event: "[타격 이벤트]", dir1: "[2루수]",  type: "[1루타성]", detail: "[직선타]", result: "[출루]" } },
{ code: "B-L-S-H", score: 1, when: { event: "[타격 이벤트]", dir1: "[3루수]",  type: "[1루타성]", detail: "[직선타]", result: "[출루]" } },
{ code: "B-L-S-H", score: 1, when: { event: "[타격 이벤트]", dir1: "[유격수]", type: "[1루타성]", detail: "[직선타]", result: "[출루]" } },

  /* ===== 타격(내야 뜬공 계열) ===== */
  { code: "B-IF-O",   score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[투수]",   detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O",   score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[포수]",   detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O",   score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[1루수]",  detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O",   score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[2루수]",  detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O",   score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[3루수]",  detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O",   score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[유격수]", detail: "[뜬공]", result: "[타자 아웃]" } },

  { code: "B-IF-S",   score: 0,  when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[투수]",   detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S",   score: 0,  when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[포수]",   detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S",   score: 0,  when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[1루수]",  detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S",   score: 0,  when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[2루수]",  detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S",   score: 0,  when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[3루수]",  detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S",   score: 0,  when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[유격수]", detail: "[뜬공]", result: "[출루]" } },

  { code: "B-IF-S-T", score: 0.5,when: { event: "[타격 이벤트]", type: "[텍사스히트성]", detail: "[뜬공]", result: "[출루]" } },

  /* ===== 타격(외야/장타/희생) ===== */
  { code: "B-OF-SF", score: 0.5, when: { event: "[타격 이벤트]", type: "[희생타/타점성]", detail: "[뜬공]" } },

  { code: "B-OF-O", score: 0, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[아웃성]", detail: "[뜬공]" } },
  { code: "B-OF-O", score: 0, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[아웃성]", detail: "[뜬공]" } },
  { code: "B-OF-O", score: 0, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[아웃성]", detail: "[뜬공]" } },

  { code: "B-OF-S", score: 1, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[1루타성]" } },
  { code: "B-OF-S", score: 1, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[1루타성]" } },
  { code: "B-OF-S", score: 1, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[1루타성]" } },

  { code: "B-OF-D", score: 2, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[2루타성]" } },
  { code: "B-OF-D", score: 2, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[2루타성]" } },
  { code: "B-OF-D", score: 2, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[2루타성]" } },

  { code: "B-OF-T", score: 3, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[3루타성]" } },
  { code: "B-OF-T", score: 3, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[3루타성]" } },
  { code: "B-OF-T", score: 3, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[3루타성]" } },

  { code: "B-HR", score: 4, when: { event: "[타격 이벤트]", type: "[홈런성]" } }
];

/* ====== 상태 ====== */
let starterKeys = ["1","2","3","4","5","6","7","8","9"];
let benchKeys   = ["q","w","e","r","t"];
let lineupMap = {};
let lineupApplied = false;
let logSeq = 0;
let scheduleNameState = "";

/* 플레이 히스토리 (누적) */
let playHistoryMap = {}; // { 선수명: [{inning:"[1회]", short:"투땅실"}, ...] }
let lastInning = "";     // 최근 이닝 태그용

const steps = [
  { name: "이닝 선택",   options: ["[1회]", "[2회]", "[3회]", "[4회]", "[5회]", "[6회]"] },
  { name: "타순 선택",   options: ["[1번]", "[2번]", "[3번]", "[4번]", "[5번]", "[6번]", "[7번]", "[8번]", "[9번]"] },
  { name: "선수 선택",   options: [] },
  { name: "이벤트 선택", options: ["[타격 이벤트]", "[삼진/사사구/기타 이벤트]", "[주루 이벤트]"] },
  { name: "타구 방향1",  options: ["[투수]", "[포수]", "[1루수]", "[2루수]", "[3루수]", "[유격수]", "[좌익수]", "[중견수]", "[우익수]"] },
  { name: "타구 방향2",  options: ["[앞]", "[뒤]", "[선상]", "[옆]"] },
  { name: "타구 성격",   options: [] },
  { name: "타구 종류",   options: [] },
  { name: "타격 결과",   options: [] }
];

let currentStep = 0;
let currentValues = [];
let eventType = "";

/* ====== 자동저장 설정 ====== */
const LS_PREFIX = "eagles_v36_";
const LS_KEYS = {
  lineup: LS_PREFIX + "lineup",
  table : LS_PREFIX + "table",
  state : LS_PREFIX + "state",
  meta  : LS_PREFIX + "meta"
};
let saveTimer = null;
function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveAll, 250); }
function saveAll(){
  try{
    const lineupPayload = { lineupMap, lineupApplied, starterKeys, benchKeys, scheduleNameState };
    localStorage.setItem(LS_KEYS.lineup, JSON.stringify(lineupPayload));

    const tableData = serializeTable();
    localStorage.setItem(LS_KEYS.table, JSON.stringify({ logSeq, rows: tableData }));

    const statePayload = { currentStep, currentValues, eventType, stepsOptions3: steps[2].options, playHistoryMap, lastInning };
    localStorage.setItem(LS_KEYS.state, JSON.stringify(statePayload));

    localStorage.setItem(LS_KEYS.meta, JSON.stringify({ savedAt: Date.now() }));
  }catch(e){
    console.warn("자동저장 실패:", e);
  }
}
function loadAll(){
  try{
    const line = JSON.parse(localStorage.getItem(LS_KEYS.lineup) || "null");
    const table = JSON.parse(localStorage.getItem(LS_KEYS.table)  || "null");
    const state = JSON.parse(localStorage.getItem(LS_KEYS.state)  || "null");

    if (line && line.lineupMap) {
      lineupMap = line.lineupMap || {};
      lineupApplied = !!line.lineupApplied;
      scheduleNameState = line.scheduleNameState || "";
      const scheduleInput = document.getElementById("scheduleName");
      if (scheduleInput) scheduleInput.value = scheduleNameState;

      const hasAnyName = Object.keys(lineupMap).some(k => (lineupMap[k] || "").trim().length > 0);
      if (!hasAnyName) lineupApplied = false;

      const playerOptions = [];
      starterKeys.forEach(k => { if (lineupMap[k]) playerOptions.push({ key: k, label: lineupMap[k] }); });
      benchKeys.forEach(k   => { if (lineupMap[k]) playerOptions.push({ key: k, label: lineupMap[k] }); });
      steps[2].options = playerOptions;

      document.getElementById("lineupInput").style.display = lineupApplied ? "none" : "block";
      renderLineupSummary();
    } else {
      document.getElementById("lineupInput").style.display = "block";
      lineupApplied = false;
      renderLineupSummary();
    }

    if (table && Array.isArray(table.rows)) {
      logSeq = table.logSeq || table.rows.length;
      renderTableFrom(table.rows); // 여기서 history 재계산됨
    }

    if (state) {
      currentStep = state.currentStep || 0;
      currentValues = Array.isArray(state.currentValues) ? state.currentValues : [];
      eventType = state.eventType || "";
      if (Array.isArray(state.stepsOptions3)) steps[2].options = state.stepsOptions3;
      playHistoryMap = state.playHistoryMap || {};
      lastInning = state.lastInning || "";
    }

    updateLegend(); updateCurrentInputLine(); updateStepProgress(); updateInningTag(); renderLineupSummary();
  }catch(e){
    console.warn("자동복구 실패:", e);
    document.getElementById("lineupInput").style.display = "block";
    lineupApplied = false;
    renderLineupSummary();
  }
}
function clearAllStorage(){
  Object.values(LS_KEYS).forEach(k => localStorage.removeItem(k));
  try {
    Object.keys(localStorage)
      .filter(k => /^eagles_/.test(k))
      .forEach(k => localStorage.removeItem(k));
  } catch(e) { console.warn("레거시 키 제거 실패:", e); }
}

/* ====== 유틸 ====== */
function stripBrackets(str) { return str ? str.replace(/\[|\]/g, '') : ''; }
function isHitishType(t){
  return t === "1루타성" || t === "2루타성" || t === "3루타성" || t === "내야안타성";
}
function recomputeResultOptionsForHit() {
  const t = stripBrackets(currentValues[6]);
  const d = stripBrackets(currentValues[7]);
  const base = [
    { key: "1", label: "[출루]",         color: "green" },
    { key: "2", label: "[타자 아웃]",     color: "red"   },
    { key: "3", label: "[선행주자 아웃]", color: "red"   }
  ];
  if (t === "병살타성" && d === "땅볼") {
    base.push({ key: "4", label: "[더블 아웃]", color: "red" });
  }
  steps[8].options = base;
}

/* ====== 축약 생성기 ====== */
 function makeShortPlay(vals){
  // vals 인덱스: 0=이닝, 1=타순, 2=선수, 3=이벤트, 4=방향1, 5=방향2, 6=성격/타구성격, 7=종류/디테일, 8=결과
  const ev = stripBrackets(vals[3] || "");

  // ✅ 1) 삼진/사사구/기타 이벤트 축약
  if (ev === "삼진/사사구/기타 이벤트") {
    const t = stripBrackets(vals[7] || ""); // 종류: 삼진/볼넷/사구/기타
    const r = stripBrackets(vals[8] || ""); // 결과: 출루/아웃/기타...

    if (t === "삼진") return (r || "").includes("출루") ? "삼출" : "삼진";
    if (t === "볼넷") return "볼넷";
    if (t === "사구") return "사구";
    return "기타";
  }

  // ✅ 2) 타격 이벤트 축약
  if (ev !== "타격 이벤트") return ""; // (필요 시 주루 이벤트도 확장 가능)

  const dir1 = stripBrackets(vals[4] || "");
  const dir2 = stripBrackets(vals[5] || "");
  const type = stripBrackets(vals[6] || "");
  const det  = stripBrackets(vals[7] || "");
  const res  = stripBrackets(vals[8] || "");

  // 수비 포지션/방향 축약 맵
  const D1 = { "좌익수":"좌", "중견수":"중", "우익수":"우",
               "유격수":"유", "3루수":"3", "2루수":"2", "1루수":"1", "투수":"투", "포수":"포" };
  const D2 = { "뒤":"월", "선상":"선", "옆":"측", "앞":"" };
  const OUT = { "땅볼":"땅", "뜬공":"플", "직선타":"직" };

  const d1 = D1[dir1] || "";
  const d2 = (dir2 in D2) ? D2[dir2] : "";

  // --- 출루 케이스 ---
  if ((res || "").includes("출루")){
    if (type === "홈런성") return "홈런";
    if (type === "2루타성") return `${d1}${d2}2`;
    if (type === "3루타성") return `${d1}${d2}3`;
    if (["1루타성","내야안타성","텍사스히트성"].includes(type)) return `${d1}${d2}안`;

    // 아웃성/병살타성인데 실책 등으로 출루 → '투땅실', '유플실', '좌직실' 등
    if (type === "아웃성" || type === "병살타성") {
      const o = OUT[det] || "";
      return `${d1}${d2}${o}실`;
    }
  }

  // --- 아웃 케이스(타자 아웃/더블 아웃/선행주자 아웃) ---
  if (res === "타자 아웃" || res === "더블 아웃" || res === "선행주자 아웃"){
    const o = OUT[det] || "";
    return `${d1}${d2}${o}`;
  }

  // --- 희생 플라이 ---
  if (type === "희생타/타점성" && det === "뜬공") return `${d1}${d2}희플`;

  return "";
}

/* ====== 규칙/코드 ====== */
function buildContextFrom(vals){
  const ctx = { event: vals[3] || "-", dir1: vals[4] || "-", dir2: vals[5] || "-", type: "-", detail: "-", result: "-" };
  if (ctx.event === "[타격 이벤트]") {
    ctx.type   = vals[6] || "-";
    ctx.detail = vals[7] || "-";
    ctx.result = vals[8] || "-";
  } else if (ctx.event === "[삼진/사사구/기타 이벤트]") {
    ctx.type   = vals[7] || "-";
    ctx.result = vals[8] || "-";
  } else if (ctx.event === "[주루 이벤트]") {
    ctx.type   = vals[6] || "-";
    ctx.result = vals[7] || "-";
  }
  return ctx;
}
function ruleMatches(ctx, rule){
  const w = rule.when || {};
  if (w.event  && w.event  !== ctx.event)  return false;
  if (w.dir1   && w.dir1   !== ctx.dir1)   return false;
  if (w.dir2   && w.dir2   !== ctx.dir2)   return false;
  if (w.type   && w.type   !== ctx.type)   return false;
  if (w.detail && w.detail !== ctx.detail) return false;
  if (w.result && w.result !== ctx.result) return false;
  return true;
}
function getCodeAndScore(vals) {
  const ctx = buildContextFrom(vals);
  const RULES = window.CODE_RULES || [];
  for (const r of RULES) {
    if (ruleMatches(ctx, r)) return { code: r.code, score: r.score };
  }
  return { code: "", score: "" };
}

/* ====== 자연어 기록 ====== */
function hitLabel(t){
  if (t === "1루타성" || t === "내야안타성") return " (안타성)";
  if (t === "2루타성") return " (2루타성)";
  if (t === "3루타성") return " (3루타성)";
  return "";
}

function buildRecord(vals) {
  // vals 인덱스: 0=이닝, 1=타순, 2=선수, 3=이벤트, 4=방향1, 5=방향2, 6=성격/타구성격, 7=종류/디테일, 8=결과
  const ev   = stripBrackets(vals[3] || "");
  const dir1 = stripBrackets(vals[4] || "");
  const dir2 = stripBrackets(vals[5] || "");
  const type = stripBrackets(vals[6] || "");
  const det  = stripBrackets(vals[7] || "");
  const res  = stripBrackets(vals[8] || "");

  const head = [dir1, (dir2 && dir2 !== "-") ? dir2 : ""].filter(Boolean).join(" ");
  const posPrefix = dir1 ? (dir1 + " ") : "";

  // ✅ 1) 삼진/사사구/기타 이벤트 자연어
  if (ev === "삼진/사사구/기타 이벤트") {
    const t = stripBrackets(vals[7] || "");
    const r = stripBrackets(vals[8] || "");
    if (t === "삼진") return (r || "").includes("출루") ? "삼진 (낫아웃 출루)" : "삼진";
    if (t === "볼넷") return "볼넷";
    if (t === "사구") return "사구";
    return "기타";
  }

  // ✅ 2) 주루 이벤트
  if (ev === "주루 이벤트") {
    // 기존 구조가 6:주루카테고리, 7:세부유형, 8:결과(혹은 그대로)라면,
    // 기록은 7 또는 8 중 의미 있는 값을 노출
    return stripBrackets(vals[7]) || stripBrackets(vals[8]) || "-";
  }

  // 선행주자 아웃 특수 문구
  if (det === "땅볼" && res === "선행주자 아웃") {
    return `${posPrefix}땅볼로 선행주자 아웃`.trim();
  }
  if (type === "병살타성" && det === "땅볼" && res === "더블 아웃") {
    return `${posPrefix}땅볼로 병살 아웃`.trim();
  }
  if ((det === "뜬공" || det === "직선타") && res === "선행주자 아웃") {
    const kind = (det === "뜬공" ? "플라이" : "직선타");
    const suffix = hitLabel(type);
    return head ? `${head} ${kind}로 선행주자 아웃${suffix}` : `${kind}로 선행주자 아웃${suffix}`;
  }

  // 희생타/타점성
  if (type === "희생타/타점성" && det === "뜬공") return `${posPrefix}희생 플라이`.trim();
  if (type === "희생타/타점성" && det === "땅볼") {
    if (res === "타자 아웃") return `${posPrefix}땅볼 아웃 (타점)`.trim();
    // 출루/선행주자 아웃이어도 타점이면 그냥 '땅볼 (타점)'
    if (res === "선행주자 아웃" || res === "출루" || (res || "").includes("출루")) return `${posPrefix}땅볼 (타점)`.trim();
    return `${posPrefix}땅볼 (타점)`.trim();
  }

  // 출루 케이스들
  if (type === "홈런성") return head ? `${head} 홈런` : "홈런";
  if ((res && res.includes("출루")) && (type === "아웃성" || type === "병살타성")) {
    const kind = (det === "뜬공" ? "플라이" : det);
    return head ? `${head} ${kind} 실책으로 출루` : `${kind} 실책으로 출루`;
  }
  if (res && res.includes("출루")) {
    const mapType = {
      "1루타성":"1루타", "2루타성":"2루타", "3루타성":"3루타",
      "내야안타성":"내야안타", "텍사스히트성":"텍사스히트"
    };
    const t = mapType[type] || type;
    return head ? `${head} ${t}` : t;
  }

  // 아웃/더블아웃
  if (res === "타자 아웃" || res === "더블 아웃") {
    const kind = (det === "뜬공" ? "플라이" : det);
    const base = head ? `${head} ${kind} ${res === "더블 아웃" ? "더블 아웃" : "아웃"}` : `${kind} ${res === "더블 아웃" ? "더블 아웃" : "아웃"}`;
    const suffix = (res === "타자 아웃") ? hitLabel(type) : "";
    return base + suffix;
  }

  // 기본 폴백
  return "-";
}

/* ====== 초기화 ====== */
window.onload = () => {
  const starterDiv = document.getElementById("starterInputs");
  for (let i = 0; i < 9; i++) starterDiv.innerHTML += `<input id="starter${i}" placeholder="${i+1}번">`;
  const benchDiv = document.getElementById("benchInputs");
  for (let i = 0; i < 5; i++) benchDiv.innerHTML += `<input id="bench${i}" placeholder="${benchKeys[i]}">`;

  document.getElementById("applyLineupBtn").addEventListener("click", applyLineup);
  setSelectAllBehavior();
  bindResetAll();

  loadAll();
};

function clearLineupInputs(){
  for (let i = 0; i < 9; i++) { const el = document.getElementById(`starter${i}`); if (el) el.value = ""; }
  for (let i = 0; i < 5; i++) { const el = document.getElementById(`bench${i}`);   if (el) el.value = ""; }
}

/* ====== 라인업 적용/표시 ====== */
function applyLineup() {
  const starters = starterKeys.map((k, i) => document.getElementById("starter"+i).value).filter(Boolean);
  const bench    = benchKeys.map((k, i) => document.getElementById("bench"+i).value).filter(Boolean);

  const scheduleInput = document.getElementById("scheduleName");
  scheduleNameState = (scheduleInput && scheduleInput.value.trim()) || "";

  lineupMap = {};
  starters.forEach((name, i) => lineupMap[starterKeys[i]] = name);
  bench.forEach((name, i)    => lineupMap[benchKeys[i]]   = name);

  const playerOptions = [];
  starterKeys.forEach(k => { if (lineupMap[k]) playerOptions.push({ key: k, label: lineupMap[k] }); });
  benchKeys.forEach(k   => { if (lineupMap[k]) playerOptions.push({ key: k, label: lineupMap[k] }); });
  steps[2].options = playerOptions;

  currentStep = 0;
  currentValues = [];
  eventType = "";
  lineupApplied = true;

  updateLegend(); updateCurrentInputLine(); updateStepProgress();
  document.getElementById("lineupInput").style.display = "none";
  renderLineupSummary();
  scheduleSave();
}

function updateInningTag(){
  const tag = document.getElementById("currentInningTag");
  if (lastInning){
    tag.textContent = `최근 이닝: ${stripBrackets(lastInning)}`;
    tag.style.display = "inline-block";
  }else{
    tag.textContent = "";
    tag.style.display = "none";
  }
}

function renderLineupSummary() {
  const box = document.getElementById('lineupSummary');
  if (!box) return;

  function histString(name){
    const items = (playHistoryMap[name] || []).map(h => `${stripBrackets(h.inning)} ${h.short}`);
    return items.length ? `<span class="miniPlay">${items.join(", ")}</span>` : '';
  }

  const startersHtml = starterKeys
    .map(k => {
      if (!lineupMap[k]) return '';
      const name = lineupMap[k];
      return `<div><span class="key">${k}</span> ${name} ${histString(name)}</div>`;
    }).join('') || '<div>-</div>';

  const benchHtml = benchKeys
    .map(k => {
      if (!lineupMap[k]) return '';
      const name = lineupMap[k];
      return `<div><span class="key">${k}</span> ${name} ${histString(name)}</div>`;
    }).join('') || '<div>-</div>';

  document.getElementById('starterList').innerHTML = startersHtml;
  document.getElementById('benchList').innerHTML = benchHtml;
  box.style.display = lineupApplied ? 'block' : 'none';
  updateInningTag();
}

/* ====== 키 입력 ====== */
document.addEventListener("keydown", (e) => {
  if (!lineupApplied) return;

  if (e.key === "Escape") {
    currentStep = 0; currentValues = []; eventType = "";
    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    scheduleSave();
    return;
  }

  const step = steps[currentStep];
  const options = step.options;

  // 선수 선택 스텝: 1~9, q~t
  if (currentStep === 2) {
    const k = normalizePlayerKey(e.key);
    if (lineupMap[k]) {
      currentValues.push(lineupMap[k]);
      currentStep++;
      updateLegend(); updateCurrentInputLine(); updateStepProgress();
      scheduleSave();
      return;
    }
  }

  // 성격/타구 성격 스텝의 단축키(₩ 등)
  if (currentStep === 6) {
    const normalizedKey = (e.key === "\\" || e.key === "`") ? "₩" : e.key;
    const match = options.find(o => typeof o === "object" && o.key === normalizedKey);
    if (match) {
      currentValues.push(match.label);
      currentStep++;
      updateLegend(); updateCurrentInputLine(); updateStepProgress();
      scheduleSave();
      return;
    }
  }

  // 이벤트 선택 (3)
  if (currentStep === 3 && e.key >= "1" && e.key <= "3") {
    const selected = step.options[parseInt(e.key) - 1];
    currentValues.push(selected);
    eventType = selected;

    if (selected === "[삼진/사사구/기타 이벤트]") {
      currentValues.push("-", "-", "-");
      steps[7].options = [
        { key: "₩", label: "[삼진]", color: "red" },
        { key: "1", label: "[볼넷]", color: "green" },
        { key: "2", label: "[사구]", color: "green" },
        { key: "3", label: "[기타]", color: "yellow" }
      ];
      currentStep = 7;

    } else if (selected === "[주루 이벤트]") {
      currentValues.push("-", "-");
      steps[6].options = ["[도루]", "[진루]", "[아웃]", "[진루 기회 놓침]", "[주루 작전]"];
      currentStep = 6;

    } else {
      steps[4].options = ["[투수]", "[포수]", "[1루수]", "[2루수]", "[3루수]", "[유격수]", "[좌익수]", "[중견수]", "[우익수]"];
      steps[5].options = ["[앞]", "[뒤]", "[선상]", "[옆]"];
      steps[6].options = [
        { key: "₩", label: "[아웃성]",      color: "red"   },
        { key: "1", label: "[1루타성]",     color: "green" },
        { key: "2", label: "[2루타성]",     color: "green" },
        { key: "3", label: "[3루타성]",     color: "green" },
        { key: "4", label: "[홈런성]",      color: "green" },
        { key: "5", label: "[내야안타성]",   color: "green" },
        { key: "6", label: "[텍사스히트성]", color: "green" },
        { key: "7", label: "[병살타성]",     color: "red"   },
        { key: "8", label: "[희생타/타점성]", color: "green" }
      ];
      steps[7].options = ["[땅볼]", "[직선타]", "[뜬공]"];
      steps[8].options = [
        { key: "1", label: "[출루]",         color: "green" },
        { key: "2", label: "[타자 아웃]",     color: "red"   },
        { key: "3", label: "[선행주자 아웃]", color: "red"   }
      ];
      currentStep++;
    }

    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    scheduleSave();
    return;
  }

  // 삼진/사사구/기타 - 종류 선택
  if (eventType === "[삼진/사사구/기타 이벤트]" && currentStep === 7) {
    const normalizedKey = (e.key === "\\" || e.key === "`") ? "₩" : e.key;
    const match = steps[7].options.find(o => o.key === normalizedKey);
    if (!match) return;
    currentValues.push(match.label);

    if (match.label === "[볼넷]" || match.label === "[사구]") {
      steps[8].options = [{ key: "1", label: "[출루]", color: "green" }];
    } else if (match.label === "[삼진]") {
      steps[8].options = [
        { key: "₩", label: "[아웃]", color: "red" },
        { key: "1", label: "[출루]", color: "green" }
      ];
    } else {
      steps[8].options = [
        { key: "₩", label: "[아웃]", color: "red" },
        { key: "1", label: "[출루]", color: "green" },
        { key: "2", label: "[기타]", color: "yellow" }
      ];
    }
    currentStep = 8;
    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    scheduleSave();
    return;
  }

  // 삼진/사사구/기타 - 결과 선택 후 종료
  if (eventType === "[삼진/사사구/기타 이벤트]" && currentStep === 8) {
    const normalizedKey = (e.key === "\\" || e.key === "`") ? "₩" : e.key;
    const match = steps[8].options.find(o => o.key === normalizedKey);
    if (match) {
      currentValues.push(match.label);
      currentStep++;
      if (currentStep === 9) writeRowAndReset();
      else { updateLegend(); updateCurrentInputLine(); updateStepProgress(); scheduleSave(); }
      return;
    }
  }

  // 주루 이벤트 세부 선택
  if (eventType === "[주루 이벤트]" && currentStep === 6 && e.key >= "1" && e.key <= "5") {
    const selected = steps[6].options[parseInt(e.key) - 1];
    currentValues.push(selected);
    let types = [];
    if (selected === "[도루]") types = [
      { key: "1", label: "[2루 도루 (2구 이내)]", color: "green" },
      { key: "2", label: "[2루 도루 (3구 이상)]", color: "green" },
      { key: "3", label: "[3루 도루]", color: "green" }
    ];
    if (selected === "[진루]") types = [
      { key: "1", label: "[2루 ETB]", color: "green" },
      { key: "2", label: "[3루 ETB]", color: "green" },
      { key: "3", label: "[홈 ETB]", color: "green" },
      { key: "4", label: "[상대 폭투로 진루]", color: "yellow" },
      { key: "5", label: "[상대 실책으로 진루]", color: "yellow" },
      { key: "6", label: "[진루타로 진루]", color: "yellow" }
    ];
    if (selected === "[아웃]") types = [
      { key: "1", label: "[도루자/주루사 (2루)]", color: "red" },
      { key: "2", label: "[도루자/주루사 (3루)]", color: "red" },
      { key: "3", label: "[도루자/주루사 (홈)]", color: "red" }
    ];
    if (selected === "[진루 기회 놓침]") types = [
      { key: "1", label: "[진루 기회 놓침 (2루/3루)]", color: "red" },
      { key: "2", label: "[진루 기회 놓침 (홈)]", color: "red" },
      { key: "3", label: "[도루 기회 놓침]", color: "red" }
    ];
    if (selected === "[주루 작전]") types = [
      { key: "1", label: "[주루 작전 성공]", color: "green" },
      { key: "2", label: "[주루 작전 실패]", color: "red" }
    ];
    steps[7].options = types;
    currentStep++;
    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    scheduleSave();
    return;
  }

  // 공통: 1~9 선택
  if (e.key >= "1" && e.key <= "9") {
    const index = parseInt(e.key) - 1;
    if (options && options[index]) {
      const val = options[index];
      currentValues.push(typeof val === "object" ? val.label : val);
      currentStep++;

      if (eventType === "[타격 이벤트]" && currentStep === 8) recomputeResultOptionsForHit();
      if (eventType === "[주루 이벤트]" && currentStep === 8) { writeRowAndReset(); return; }
      if (currentStep === 9) { writeRowAndReset(); return; }

      updateLegend(); updateCurrentInputLine(); updateStepProgress();
      scheduleSave();
    }
  }

  if (e.key === "Backspace") {
    if (currentStep > 0) {
      currentStep--; currentValues.pop();
      updateLegend(); updateCurrentInputLine(); updateStepProgress();
      scheduleSave();
    }
    e.preventDefault();
  }
});

function normalizePlayerKey(key) {
  if (!key) return key;
  const hangulToLatin = { "ㅂ":"q", "ㅈ":"w", "ㄷ":"e", "ㄱ":"r", "ㅅ":"t" };
  if (key.length === 1) {
    if (hangulToLatin[key]) return hangulToLatin[key];
    return key.toLowerCase();
  }
  return key;
}

/* ====== 히스토리 관리 ====== */
function pushPlayHistory(playerName, inning, shortTxt){
  if (!playerName || !shortTxt) return;
  if (!playHistoryMap[playerName]) playHistoryMap[playerName] = [];
  playHistoryMap[playerName].push({ inning, short: shortTxt });
}

/* ====== 로그 행 쓰기 & 리셋 ====== */
function writeRowAndReset() {
  const { code, score } = getCodeAndScore(currentValues);
  const tbody = document.getElementById("logTable").tBodies[0];
  const row = tbody.insertRow(0);

  // 화면의 '#' 컬럼에는 순번만 표기
  const seqText = (++logSeq);
  row.insertCell(0).innerHTML = '<input type="checkbox" class="rowSel">';
  row.insertCell(1).innerText = String(seqText);

  // 스텝 값 채우기
  for (let i = 0; i < steps.length; i++) {
    row.insertCell(i + 2).innerText = currentValues[i] || "-";
  }

  // 기록, 코드, 점수
  row.insertCell(steps.length + 2).innerText = buildRecord(currentValues);
  row.insertCell(steps.length + 3).innerText = code || "-";
  row.insertCell(steps.length + 4).innerText = (score !== "" ? score : "-");

  // ── 히스토리/최근 이닝 갱신 ──
  const playerName = currentValues[2];
  const mini = makeShortPlay(currentValues);
  const inning = currentValues[0] || "";
  if (playerName && mini) pushPlayHistory(playerName, inning, mini);
  lastInning = inning || lastInning;
  renderLineupSummary();

  // 입력 상태 리셋
  currentStep = 0;
  currentValues = [];
  eventType = "";

  // UI 반영 + 자동저장
  updateLegend();
  updateCurrentInputLine();
  updateStepProgress();
  scheduleSave();
}

/* ====== 테이블 직렬화/복구 ====== */
function serializeTable(){
  const tbody = document.querySelector("#logTable tbody");
  const rows = [];
  Array.from(tbody.rows).forEach(tr => {
    const cells = Array.from(tr.cells).map(td => td.textContent);
    rows.push({
      perf: cells[1],
      values: cells.slice(2, 2 + steps.length),
      record: cells[2 + steps.length],
      code:   cells[3 + steps.length],
      score:  cells[4 + steps.length]
    });
  });
  return rows;
}
function renderTableFrom(rows){
  const tbody = document.querySelector("#logTable tbody");
  tbody.innerHTML = "";
  (rows || []).forEach(r => {
    const tr = tbody.insertRow(-1);
    tr.insertCell(0).innerHTML = '<input type="checkbox" class="rowSel">';
    tr.insertCell(1).innerText = r.perf || "";
    (r.values || []).forEach(v => tr.insertCell(-1).innerText = v || "-");
    tr.insertCell(-1).innerText = r.record || "";
    tr.insertCell(-1).innerText = r.code   || "-";
    tr.insertCell(-1).innerText = (r.score !== undefined && r.score !== null) ? r.score : "-";
  });

  // 히스토리 재계산
  playHistoryMap = {};
  lastInning = "";
  (rows || []).forEach(r => {
    const vals = r.values || [];
    const name = vals[2];
    const mini = makeShortPlay(vals);
    const inn  = vals[0] || "";
    if (name && mini) pushPlayHistory(name, inn, mini);
    if (!lastInning && vals[0]) lastInning = vals[0];
  });
  renderLineupSummary();
}

/* ====== 삭제/선택/CSV/초기화 ====== */
function deleteSelectedRows() {
  const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
  const checked = Array.from(tbody.querySelectorAll('input.rowSel:checked'));
  if (checked.length === 0) return;
  checked.forEach(cb => {
    const tr = cb.closest('tr');
    if (tr && tr.parentNode === tbody) tbody.removeChild(tr);
  });
  const selectAll = document.getElementById('selectAll');
  if (selectAll) selectAll.checked = false;

  // 삭제 후 히스토리 재계산
  const rows = serializeTable();
  playHistoryMap = {};
  lastInning = "";
  rows.forEach(r => {
    const vals = r.values || [];
    const nm = vals[2];
    const m = makeShortPlay(vals);
    if (nm && m) pushPlayHistory(nm, vals[0] || "", m);
    if (!lastInning && vals[0]) lastInning = vals[0];
  });
  renderLineupSummary();

  scheduleSave();
}

function csvEscape(value) { const v = (value ?? "").toString(); return `"${v.replace(/"/g, '""')}"`; }
function tableToCSV() {
  const table = document.getElementById("logTable");
  const thead = table.tHead;
  const tbody = table.tBodies[0];

  // CSV 헤더
  const headerCells = Array.from(thead.rows[0].cells).slice(1); // 체크박스 제외
  const headers = headerCells.map(th => th.textContent.trim());
  if (headers.length > 0) headers[0] = "성과객체명"; // '#' → '성과객체명'
  headers.push("일정명"); // 마지막에 일정명 컬럼 추가

  const rows = [headers.map(csvEscape).join(",")];

  // CSV 내용
  Array.from(tbody.rows).forEach(tr => {
    const cells = Array.from(tr.cells).slice(1); // 체크박스 제외
    const vals = cells.map(td => td.textContent.trim());

    // 첫 컬럼(#) → 일정명 + 순번
    const seq = vals[0] || "";
    const perfCsv = (scheduleNameState ? `${scheduleNameState} ${seq}` : seq);
    vals[0] = perfCsv;

    // 마지막에 일정명 값 추가
    vals.push(scheduleNameState || "");

    rows.push(vals.map(csvEscape).join(","));
  });

  return rows.join("\n");
}
function downloadCSV() {
  const csv = tableToCSV();
  const filename = (() => {
    const d = new Date();
    const pad = n => String(n).padStart(2, "0");
    return `eagles_logs_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.csv`;
  })();

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  if (typeof a.download === "undefined") {
    const dataUrl = "data:text/csv;charset=utf-8,\uFEFF" + encodeURIComponent(csv);
    window.open(dataUrl); return;
  }
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function setSelectAllBehavior() {
  const selectAll = document.getElementById('selectAll');
  const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
  if (!selectAll) return;

  selectAll.addEventListener('change', () => {
    const boxes = tbody.querySelectorAll('input.rowSel');
    boxes.forEach(b => b.checked = selectAll.checked);
  });

  document.getElementById('deleteSelected').addEventListener('click', deleteSelectedRows);
  const exportBtn = document.getElementById('exportCsv');
  if (exportBtn) exportBtn.addEventListener('click', downloadCSV);
}
function bindResetAll(){
  const btn = document.getElementById("resetAll");
  btn.addEventListener("click", () => {
    const ok = confirm("정말 전체 초기화할까요? (라인업/진행상태/로그, 저장데이터 모두 삭제)");
    if (!ok) return;

    document.querySelector("#logTable tbody").innerHTML = "";
    logSeq = 0;

    lineupMap = {};
    lineupApplied = false;
    currentStep = 0;
    currentValues = [];
    eventType = "";

    playHistoryMap = {};
    lastInning = "";
    scheduleNameState = "";
    const scheduleInput = document.getElementById("scheduleName");
    if (scheduleInput) scheduleInput.value = "";

    document.getElementById("lineupInput").style.display = "block";
    document.getElementById('starterList').innerHTML = "";
    document.getElementById('benchList').innerHTML = "";
    document.getElementById('lineupSummary').style.display = "none";
    clearLineupInputs();

    steps[2].options = [];

    updateLegend(); updateCurrentInputLine(); updateStepProgress();

    clearAllStorage();
  });
}

// 스텝 진행 표시
function updateStepProgress() {
  const box = document.getElementById('stepProgress');
  if (!box) return;
  const html = steps.map((s, i) =>
    `<div class="stepBox ${i===currentStep ? 'active' : ''}">${i+1}. ${s.name}</div>`
  ).join('');
  box.innerHTML = html;
}

// 현재 입력 줄
function updateCurrentInputLine() {
  const el = document.getElementById('currentInputLine');
  if (!el) return;
  const picked = currentValues.map(v => v || '-').join(' → ');
  el.textContent = `[현재 입력 중] → ${picked}`;
}

// 전광판(선택지)
function updateLegend() {
  const ul = document.getElementById('legendList');
  if (!ul) return;

  const step = steps[currentStep] || { options: [] };
  const opts = step.options || [];

  const items = opts.map((o, idx) => {
    if (typeof o === 'object' && o.key && o.label) {
      const color = (o.color === 'red' || o.color === 'green' || o.color === 'yellow') ? o.color : 'green';
      return `<li><span class="${color}">[${o.key}]</span> <span class="${color}">${o.label}</span></li>`;
    }
    return `<li><span class="">[${idx + 1}]</span> ${o}</li>`;
  });
  ul.innerHTML = items.join('') || '<li>-</li>';
}

/* ====== 종료 시 저장 ====== */
window.addEventListener("beforeunload", () => { try { saveAll(); } catch(e) {} });
</script>
</body>
</html>