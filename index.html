<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>이글스 성과평가 단축키 입력 시스템 v3.0</title>
  <style>
    body { font-family: sans-serif; margin: 30px; }
    h1 { margin-bottom: 10px; }
    .lineup-input { margin-bottom: 20px; }
    .lineup-input input { margin: 2px; }
    .actions { margin: 6px 0; }

    #stepProgress { margin: 12px 0 16px; display: flex; flex-wrap: wrap; gap: 8px; }
    .stepBox {
      padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc;
      background-color: #eee; font-weight: bold; font-size: 14px;
    }
    .stepBox.active { background-color: #007bff; color: #fff; border-color: #007bff; }

    #currentInputLine {
      font-size: 16px; margin-top: 10px; margin-bottom: 6px;
      font-weight: bold; color: #333;
    }
    #hint { font-size: 12px; color: #666; margin-bottom: 16px; }

    .log { margin-top: 24px; border-top: 1px solid #ccc; padding-top: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    .flash-bg { background-color: #cce5ff; transition: background-color 0.6s ease; }

    /* 상단 레이아웃: 왼쪽 legend, 오른쪽 라인업 전체 박스 */
    .topRow { display: flex; align-items: flex-start; gap: 16px; }

    /* 선택지 박스: v3.0에서 살짝 더 짙게 */
    #legendBox {
      flex: 0 0 300px; max-width: 300px;
      margin: 15px 0 8px 0; padding: 10px 15px;
      border: 1px solid #cfd8e3; background-color: #e9eef5; /* 기존 #f9f9f9 → 살짝 진하게 */
      border-radius: 6px;
    }
    #legendBox strong { display:block; margin-bottom:4px; }
    #legendBox ul { list-style: none; padding-left: 0; margin: 6px 0 0; }
    #legendBox li { margin: 4px 0; }
    .red { color: red; font-weight: bold; }
    .green { color: green; font-weight: bold; }

    /* 오른쪽: 큰 라인업 박스 */
    #lineupSummary {
      flex: 1 1 auto;
      border: 1px solid #ddd; background: #f9f9f9;
      padding: 12px; display: none;  /* 적용 전엔 숨김 */
    }
    #lineupSummary h3 { margin: 0 0 8px; }

    /* 큰 박스 내부: 두 개의 소박스(선발/교체) 나란히 */
    #lineupWrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .lineupPanel {
      border: 1px solid #e2e2e2; background: #fff;
      padding: 10px; min-width: 220px;
    }
    .lineupPanel h4 { margin: 0 0 6px; font-size: 14px; }
    .key { width: 28px; display: inline-block; color: #888; }
    #starterList > div, #benchList > div { border-bottom: 1px dashed #eee; padding: 2px 0; }
  </style>
</head>
<body>
  <h1>
  <img src="IMG_2742.png" alt="이글스 로고" style="width:50px;height:50px;vertical-align:middle;margin-right:8px;">
  이글스 성과평가 단축키 입력 시스템 <span style="font-size:.7em;color:#888;">v3.0</span>
</h1>
    <!-- 라인업 입력 -->
  <div class="lineup-input" id="lineupInput">
    <div><strong>선발 (1~9번):</strong></div>
    <div id="starterInputs"></div>
    <div style="margin-top:6px;"><strong>대기 (q~t):</strong></div>
    <div id="benchInputs"></div>
    <button style="margin-top:8px;" onclick="applyLineup()">라인업 적용</button>
  </div>

  <!-- 진행 스텝 표시 -->
  <div id="stepProgress"></div>

  <!-- 상단: 왼쪽(legend) + 오른쪽(라인업 패널들) -->
  <div class="topRow">
    <div id="legendBox">
      <strong>선택지 (단축키 입력 가능):</strong>
      <ul id="legendList"></ul>
    </div>

    <!-- 큰 라인업 박스: 내부에 두 개 소박스 -->
    <div id="lineupSummary">
      <h3>라인업</h3>
      <div id="lineupWrapper">
        <div class="lineupPanel">
          <h4>선발 (1~9)</h4>
          <div id="starterList"></div>
        </div>
        <div class="lineupPanel">
          <h4>교체 (q~t)</h4>
          <div id="benchList"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="currentInputLine">[현재 입력 중] → </div>
  <div id="hint">ESC: 전체 초기화 / Backspace: 한 단계 롤백</div>

  <!-- 로그 -->
  <div class="log">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
  <h2 style="margin: 0;">입력 로그</h2>
  <div class="actions">
    <button id="deleteSelected">선택 삭제</button>
    <button id="exportCsv">CSV 다운로드</button>
  </div>
</div>
    <table id="logTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>#</th>
          <th>이닝</th>
          <th>타순</th>
          <th>선수</th>
          <th>이벤트</th>
          <th>방향1</th>
          <th>방향2</th>
          <th>성격</th>
          <th>종류</th>
          <th>결과</th>
          <th>기록</th>
          <th>코드</th>
          <th>점수</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* ====== CODE RULES (간단 유지) ====== */
window.CODE_RULES = [
  { code: "B-SO-O", score: -1.5, when: { event: "[삼진/사사구/기타 이벤트]", type: "[삼진]", result: "[아웃]" } },
  { code: "B-SO-S", score: 0,    when: { event: "[삼진/사사구/기타 이벤트]", type: "[삼진]", result: "[출루]" } },
  { code: "B-BB",   score: 1,    when: { event: "[삼진/사사구/기타 이벤트]", type: "[볼넷]", result: "[출루]" } },
  { code: "B-BB",   score: 1,    when: { event: "[삼진/사사구/기타 이벤트]", type: "[사구]", result: "[출루]" } },

  { code: "BR-2ndQ", score: 1,   when: { event: "[주루 이벤트]", type: "[도루]", result: "[2루 도루 (2구 이내)]" } },
  { code: "BR-2nd",  score: 0.5, when: { event: "[주루 이벤트]", type: "[도루]", result: "[2루 도루 (3구 이상)]" } },
  { code: "BR-3rd",  score: 1,   when: { event: "[주루 이벤트]", type: "[도루]", result: "[3루 도루]" } },

  { code: "BR-ETB-1", score: 1,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[2루 ETB]" } },
  { code: "BR-ETB-1", score: 1,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[3루 ETB]" } },
  { code: "BR-ETB-2", score: 1.5, when: { event: "[주루 이벤트]", type: "[진루]", result: "[홈 ETB]" } },
  { code: "BR-WP",    score: 0,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[상대 폭투로 진루]" } },
  { code: "BR-FE",    score: 0,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[상대 실책으로 진루]" } },
  { code: "BR-SF",    score: 0,   when: { event: "[주루 이벤트]", type: "[진루]", result: "[진루타로 진루]" } },

  { code: "BR-E-1", score: -1.5, when: { event: "[주루 이벤트]", type: "[아웃]", result: "[도루자/주루사 (2루)]" } },
  { code: "BR-E-1", score: -1.5, when: { event: "[주루 이벤트]", type: "[아웃]", result: "[도루자/주루사 (3루)]" } },
  { code: "BR-E-2", score: -2,   when: { event: "[주루 이벤트]", type: "[아웃]", result: "[도루자/주루사 (홈)]" } },

  { code: "BR-E-3", score: -1,   when: { event: "[주루 이벤트]", type: "[진루 기회 놓침]", result: "[진루 기회 놓침 (2루/3루)]" } },
  { code: "BR-E-5", score: -1.5, when: { event: "[주루 이벤트]", type: "[진루 기회 놓침]", result: "[진루 기회 놓침 (홈)]" } },
  { code: "BR-E-4", score: -0.5, when: { event: "[주루 이벤트]", type: "[진루 기회 놓침]", result: "[도루 기회 놓침]" } },

  { code: "BR-STP-S", score: 1,  when: { event: "[주루 이벤트]", type: "[주루 작전]", result: "[주루 작전 성공]" } },
  { code: "STP",      score: 0,  when: { event: "[주루 이벤트]", type: "[주루 작전]", result: "[주루 작전 실패]" } },

  { code: "B-G-O-1", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O-1", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[땅볼]", result: "[선행주자 아웃]" } },
  { code: "B-G-O-1", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[땅볼]", result: "[더블 아웃]" } },

  { code: "B-G-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[선행주자 아웃]" } },
  { code: "B-G-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[땅볼]", result: "[더블 아웃]" } },
  { code: "B-G-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[타자 아웃]" } },
  { code: "B-G-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[선행주자 아웃]" } },
  { code: "B-G-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[더블 아웃]" } },

  { code: "B-GD-O", score: -2, when: { event: "[타격 이벤트]", type: "[병살타성]", detail: "[땅볼]", result: "[더블 아웃]" } },

  { code: "B-G-S-1", score: 0.5, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S-1", score: 0.5, when: { event: "[타격 이벤트]", type: "[내야안타성]", detail: "[땅볼]", result: "[출루]" } },

  { code: "B-G-S-2", score: 1, when: { event: "[타격 이벤트]", dir1: "[투수]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S-2", score: 1, when: { event: "[타격 이벤트]", dir1: "[포수]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S-2", score: 1, when: { event: "[타격 이벤트]", dir1: "[1루수]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S-2", score: 1, when: { event: "[타격 이벤트]", dir1: "[2루수]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S-2", score: 1, when: { event: "[타격 이벤트]", dir1: "[3루수]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]" } },
  { code: "B-G-S-2", score: 1, when: { event: "[타격 이벤트]", dir1: "[유격수]", type: "[1루타성]", detail: "[땅볼]", result: "[출루]" } },

  { code: "B-G-SF", score: 0.5, when: { event: "[타격 이벤트]", type: "[희생타/타점성]", detail: "[땅볼]" } },

  { code: "B-L-O-1", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[타자 아웃]" } },
  { code: "B-L-O-1", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[선행주자 아웃]" } },
  { code: "B-L-O-1", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[더블 아웃]" } },

  { code: "B-L-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[직선타]", result: "[타자 아웃]" } },
  { code: "B-L-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[직선타]", result: "[선행주자 아웃]" } },
  { code: "B-L-O-2", score: 0, when: { event: "[타격 이벤트]", type: "[1루타성]", detail: "[직선타]", result: "[더블 아웃]" } },

  { code: "B-L-S-1", score: 0.5, when: { event: "[타격 이벤트]", type: "[아웃성]", detail: "[직선타]", result: "[출루]" } },

  { code: "B-IF-O", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[투수]",   detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[포수]",   detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[1루수]",  detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[2루수]",  detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[3루수]",  detail: "[뜬공]", result: "[타자 아웃]" } },
  { code: "B-IF-O", score: -1, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[유격수]", detail: "[뜬공]", result: "[타자 아웃]" } },

  { code: "B-IF-S-1", score: 0, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[투수]",   detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S-1", score: 0, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[포수]",   detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S-1", score: 0, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[1루수]",  detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S-1", score: 0, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[2루수]",  detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S-1", score: 0, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[3루수]",  detail: "[뜬공]", result: "[출루]" } },
  { code: "B-IF-S-1", score: 0, when: { event: "[타격 이벤트]", type: "[아웃성]", dir1: "[유격수]", detail: "[뜬공]", result: "[출루]" } },

  { code: "B-IF-S-2", score: 0.5, when: { event: "[타격 이벤트]", type: "[텍사스히트성]", detail: "[뜬공]", result: "[출루]" } },

  { code: "B-OF-SF", score: 0.5, when: { event: "[타격 이벤트]", type: "[희생타/타점성]", detail: "[뜬공]" } },

  { code: "B-OF-O", score: 0, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[아웃성]", detail: "[뜬공]" } },
  { code: "B-OF-O", score: 0, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[아웃성]", detail: "[뜬공]" } },
  { code: "B-OF-O", score: 0, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[아웃성]", detail: "[뜬공]" } },

  { code: "B-OF-S", score: 1, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[1루타성]" } },
  { code: "B-OF-S", score: 1, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[1루타성]" } },
  { code: "B-OF-S", score: 1, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[1루타성]" } },

  { code: "B-OF-D", score: 2, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[2루타성]" } },
  { code: "B-OF-D", score: 2, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[2루타성]" } },
  { code: "B-OF-D", score: 2, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[2루타성]" } },

  { code: "B-OF-T", score: 3, when: { event: "[타격 이벤트]", dir1: "[좌익수]", type: "[3루타성]" } },
  { code: "B-OF-T", score: 3, when: { event: "[타격 이벤트]", dir1: "[중견수]", type: "[3루타성]" } },
  { code: "B-OF-T", score: 3, when: { event: "[타격 이벤트]", dir1: "[우익수]", type: "[3루타성]" } },

  { code: "B-HR", score: 4, when: { event: "[타격 이벤트]", type: "[홈런성]" } }
];

const CODE_RULES = window.CODE_RULES;

/* ====== 상태 ====== */
let starterKeys = ["1","2","3","4","5","6","7","8","9"];
let benchKeys   = ["q","w","e","r","t"];
let lineupMap = {};
let lineupApplied = false;
let logSeq = 0;

/* ====== 스텝 정의 ====== */
const steps = [
  { name: "이닝 선택",   options: ["[1회]", "[2회]", "[3회]", "[4회]", "[5회]", "[6회]"] },
  { name: "타순 선택",   options: ["[1번타자]", "[2번타자]", "[3번타자]", "[4번타자]", "[5번타자]", "[6번타자]", "[7번타자]", "[8번타자]", "[9번타자]"] },
  { name: "선수 선택",   options: [] },
  { name: "이벤트 선택", options: ["[타격 이벤트]", "[삼진/사사구/기타 이벤트]", "[주루 이벤트]"] },
  { name: "타구 방향1",  options: ["[투수]", "[포수]", "[1루수]", "[2루수]", "[3루수]", "[유격수]", "[좌익수]", "[중견수]", "[우익수]"] },
  { name: "타구 방향2",  options: ["[앞]", "[뒤]", "[선상]", "[옆]"] },
  { name: "타구 성격",   options: [] },
  { name: "타구 종류",   options: [] },
  { name: "타격 결과",   options: [] }
];

let currentStep = 0;
let currentValues = [];
let eventType = "";

/* ====== 유틸 ====== */
function stripBrackets(str) {
  return str ? str.replace(/\[|\]/g, '') : '';
}

function buildContextFrom(vals){
  const ctx = { event: vals[3] || "-", dir1: vals[4] || "-", dir2: vals[5] || "-", type: "-", detail: "-", result: "-" };
  if (ctx.event === "[타격 이벤트]") {
    ctx.type   = vals[6] || "-";
    ctx.detail = vals[7] || "-";
    ctx.result = vals[8] || "-";
  } else if (ctx.event === "[삼진/사사구/기타 이벤트]") {
    ctx.type   = vals[7] || "-";
    ctx.result = vals[8] || "-";
  } else if (ctx.event === "[주루 이벤트]") {
    ctx.type   = vals[6] || "-";  // [도루] / [진루] / ...
    ctx.result = vals[7] || "-";  // 예: [2루 도루 (2구 이내)]
  }
  return ctx;
}

function ruleMatches(ctx, rule){
  const w = rule.when || {};
  if (w.event  && w.event  !== ctx.event)  return false;
  if (w.dir1   && w.dir1   !== ctx.dir1)   return false;
  if (w.dir2   && w.dir2   !== ctx.dir2)   return false;
  if (w.type   && w.type   !== ctx.type)   return false;
  if (w.detail && w.detail !== ctx.detail) return false;
  if (w.result && w.result !== ctx.result) return false;
  return true;
}

function getCodeAndScore(vals) {
  const ctx = buildContextFrom(vals);
  const RULES = window.CODE_RULES || [];
  for (const r of RULES) {
    if (ruleMatches(ctx, r)) {
      return { code: r.code, score: r.score };
    }
  }
  return { code: "", score: "" };
}

function buildRecord(vals) {
  const ev   = stripBrackets(vals[3]);
  const dir1 = stripBrackets(vals[4]);
  const dir2 = stripBrackets(vals[5]);
  const type = stripBrackets(vals[6]);
  const det  = stripBrackets(vals[7]);
  const res  = stripBrackets(vals[8]);
  const head = [dir1, (dir2 && dir2 !== "-") ? dir2 : ""].filter(Boolean).join(" ");
  const posPrefix = dir1 ? (dir1 + " ") : "";

  // 특수 규칙
  if (ev === "타격 이벤트" && det === "땅볼" && stripBrackets(vals[8]) === "선행주자 아웃") {
    return `${posPrefix}땅볼로 선행주자 아웃`.trim();
  }
  if (ev === "타격 이벤트" && type === "병살타성" && det === "땅볼" && stripBrackets(vals[8]) === "더블 아웃") {
    return `${posPrefix}땅볼로 병살 아웃`.trim();
  }
  if (ev === "타격 이벤트" && type === "희생타/타점성" && det === "뜬공") {
    return `${posPrefix}희생 플라이`.trim();
  }
  if (ev === "타격 이벤트" && type === "희생타/타점성" && det === "땅볼") {
    const r = stripBrackets(vals[8]) || "";
    if (r === "타자 아웃") return `${posPrefix}땅볼 아웃 (타점)`.trim();
    if (r === "선행주자 아웃" || r === "출루" || r.includes("출루")) return `${posPrefix}땅볼 (타점)`.trim();
    return `${posPrefix}땅볼 (타점)`.trim();
  }
  // 삼진 + 출루 → 낫아웃 출루
  if (ev === "삼진/사사구/기타 이벤트" && det === "삼진" && res.includes("출루")) {
    return "삼진 (낫아웃 출루)";
  }

  // 일반 규칙
  if (ev === "주루 이벤트") {
    return stripBrackets(vals[7]) || "-";  // 예: "2루 도루 (2구 이내)"
  }

  if (ev === "타격 이벤트") {
    if (type === "홈런성") return head ? `${head} 홈런` : "홈런";
    if ((res && res.includes("출루")) && type === "아웃성") {
      const kind = (det === "뜬공" ? "플라이" : det);
      return head ? `${head} ${kind} 실책으로 출루` : `${kind} 실책으로 출루`;
    }
    if (res && res.includes("출루")) {
      const mapType = { "1루타성":"1루타", "2루타성":"2루타", "3루타성":"3루타", "내야안타성":"내야안타", "텍사스히트성":"텍사스히트" };
      const t = mapType[type] || type;
      return head ? `${head} ${t}` : t;
    }
    if (res === "타자 아웃" || res === "더블 아웃") {
      const kind = (det === "뜬공" ? "플라이" : det);
      return head ? `${head} ${kind} ${res === "더블 아웃" ? "더블 아웃" : "아웃"}` : `${kind} ${res === "더블 아웃" ? "더블 아웃" : "아웃"}`;
    }
  }

  if (ev === "삼진/사사구/기타 이벤트") return det || "-";
  return "-";
}

/* ====== 초기 UI 구성 ====== */
window.onload = () => {
  const starterDiv = document.getElementById("starterInputs");
  for (let i = 0; i < 9; i++) {
    starterDiv.innerHTML += `<input id="starter${i}" placeholder="${i+1}번">`;
  }
  const benchDiv = document.getElementById("benchInputs");
  for (let i = 0; i < 5; i++) {
    benchDiv.innerHTML += `<input id="bench${i}" placeholder="${benchKeys[i]}">`;
  }
  setSelectAllBehavior();
};

function applyLineup() {
  const starters = starterKeys.map((k, i) => document.getElementById("starter"+i).value).filter(Boolean);
  const bench    = benchKeys.map((k, i) => document.getElementById("bench"+i).value).filter(Boolean);

  lineupMap = {};
  starters.forEach((name, i) => lineupMap[starterKeys[i]] = name);
  bench.forEach((name, i)    => lineupMap[benchKeys[i]]   = name);

  const playerOptions = [];
  starterKeys.forEach(k => { if (lineupMap[k]) playerOptions.push({ key: k, label: lineupMap[k] }); });
  benchKeys.forEach(k   => { if (lineupMap[k]) playerOptions.push({ key: k, label: lineupMap[k] }); });
  steps[2].options = playerOptions;

  currentStep = 0;
  currentValues = [];
  eventType = "";
  lineupApplied = true;

  updateLegend();
  updateCurrentInputLine();
  updateStepProgress();
  document.getElementById("lineupInput").style.display = "none";

  renderLineupSummary();
}

/* ====== UI 갱신 ====== */
function updateStepProgress() {
  const stepProgress = document.getElementById("stepProgress");
  stepProgress.innerHTML = "";
  steps.forEach((step, i) => {
    const box = document.createElement("div");
    box.className = "stepBox" + (i === currentStep ? " active" : "");
    box.innerText = step.name;
    stepProgress.appendChild(box);
  });
}

function updateLegend() {
  const legendList = document.getElementById("legendList");
  legendList.innerHTML = "";
  const step = steps[currentStep] || { options: [] };
  const options = step.options || [];
  options.forEach((opt, i) => {
    const li = document.createElement("li");
    if (typeof opt === "object" && opt.label) {
      li.innerHTML = `<span class="${opt.color || ''}">${opt.key ? opt.key + " - " : ""}${opt.label}</span>`;
    } else {
      li.innerText = `${i + 1} - ${opt}`;
    }
    legendList.appendChild(li);
  });
}

function updateCurrentInputLine() {
  const text = currentValues.join(" / ");
  const currentLine = document.getElementById("currentInputLine");
  currentLine.innerText = `[현재 입력 중] → ${text}`;
  currentLine.classList.add("flash-bg");
  setTimeout(() => currentLine.classList.remove("flash-bg"), 600);
}

function renderLineupSummary() {
  const box = document.getElementById('lineupSummary');
  if (!box) return;

  const startersHtml = starterKeys
    .map(k => lineupMap[k] ? `<div><span class="key">${k}</span> ${lineupMap[k]}</div>` : '')
    .join('') || '<div>-</div>';

  const benchHtml = benchKeys
    .map(k => lineupMap[k] ? `<div><span class="key">${k}</span> ${lineupMap[k]}</div>` : '')
    .join('') || '<div>-</div>';

  document.getElementById('starterList').innerHTML = startersHtml;
  document.getElementById('benchList').innerHTML = benchHtml;
  box.style.display = 'block';
}

/* ====== 키 입력 ====== */
document.addEventListener("keydown", (e) => {
  if (!lineupApplied) return;

  if (e.key === "Escape") {
    currentStep = 0;
    currentValues = [];
    eventType = "";
    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    return;
  }

  const step = steps[currentStep];
  const options = step.options;

  // 선수 선택(1~9, q~t, 한글자판 대응)
  if (currentStep === 2) {
    const k = normalizePlayerKey(e.key);
    if (lineupMap[k]) {
      currentValues.push(lineupMap[k]);
      currentStep++;
      updateLegend(); updateCurrentInputLine(); updateStepProgress();
      return;
    }
  }

  // 타구 성격 단계의 특수키(₩) 지원
  if (currentStep === 6) {
    const normalizedKey = (e.key === "\\" || e.key === "`") ? "₩" : e.key;
    const match = options.find(o => typeof o === "object" && o.key === normalizedKey);
    if (match) {
      currentValues.push(match.label);
      currentStep++;
      updateLegend(); updateCurrentInputLine(); updateStepProgress();
      return;
    }
  }

  // 이벤트 타입 선택
  if (currentStep === 3 && e.key >= "1" && e.key <= "3") {
    const selected = step.options[parseInt(e.key) - 1];
    currentValues.push(selected);
    eventType = selected;

    if (selected === "[삼진/사사구/기타 이벤트]") {
      currentValues.push("-", "-", "-");
      steps[7].options = [
        { key: "₩", label: "[삼진]", color: "red" },
        { key: "1", label: "[볼넷]", color: "green" },
        { key: "2", label: "[사구]", color: "green" },
        { key: "3", label: "[기타]", color: "red" }
      ];
      currentStep = 7;

    } else if (selected === "[주루 이벤트]") {
      currentValues.push("-", "-");
      steps[6].options = ["[도루]", "[진루]", "[아웃]", "[진루 기회 놓침]", "[주루 작전]"];
      currentStep = 6;

    } else { // 타격 이벤트
      steps[4].options = ["[투수]", "[포수]", "[1루수]", "[2루수]", "[3루수]", "[유격수]", "[좌익수]", "[중견수]", "[우익수]"];
      steps[5].options = ["[앞]", "[뒤]", "[선상]", "[옆]"];
      steps[6].options = [
        { key: "₩", label: "[아웃성]",      color: "red"   },
        { key: "1", label: "[1루타성]",     color: "green" },
        { key: "2", label: "[2루타성]",     color: "green" },
        { key: "3", label: "[3루타성]",     color: "green" },
        { key: "4", label: "[홈런성]",      color: "green" },
        { key: "5", label: "[내야안타성]",   color: "green" },
        { key: "6", label: "[텍사스히트성]", color: "green" },
        { key: "7", label: "[병살타성]",     color: "red"   },
        { key: "8", label: "[희생타/타점성]", color: "green" }
      ];
      steps[7].options = ["[땅볼]", "[직선타]", "[뜬공]"];
      steps[8].options = [
        { key: "1", label: "[출루]",         color: "green" },
        { key: "2", label: "[타자 아웃]",     color: "red"   },
        { key: "3", label: "[선행주자 아웃]", color: "red"   },
        { key: "4", label: "[더블 아웃]",     color: "red"   }
      ];
      currentStep++;
    }

    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    return;
  }

  // 삼진/사사구/기타: 7 → 8단계의 특수키(₩) 지원
  if (eventType === "[삼진/사사구/기타 이벤트]" && currentStep === 7) {
    const normalizedKey = (e.key === "\\" || e.key === "`") ? "₩" : e.key;
    const match = steps[7].options.find(o => o.key === normalizedKey);
    if (!match) return;
    currentValues.push(match.label);

    if (match.label === "[볼넷]" || match.label === "[사구]") {
      steps[8].options = [{ key: "1", label: "[출루]", color: "green" }];
    } else if (match.label === "[삼진]") {
      steps[8].options = [
        { key: "₩", label: "[아웃]", color: "red" },
        { key: "1", label: "[출루]", color: "green" }
      ];
    } else {
      steps[8].options = [
        { key: "₩", label: "[아웃]", color: "red" },
        { key: "1", label: "[출루]", color: "green" },
        { key: "2", label: "[기타]", color: "red" }
      ];
    }
    currentStep = 8;
    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    return;
  }

  if (eventType === "[삼진/사사구/기타 이벤트]" && currentStep === 8) {
    const normalizedKey = (e.key === "\\" || e.key === "`") ? "₩" : e.key;
    const match = steps[8].options.find(o => o.key === normalizedKey);
    if (match) {
      currentValues.push(match.label);
      currentStep++;
      if (currentStep === 9) writeRowAndReset();
      else { updateLegend(); updateCurrentInputLine(); updateStepProgress(); }
      return;
    }
  }

  // 주루 이벤트: 6 → 7단계
  if (eventType === "[주루 이벤트]" && currentStep === 6 && e.key >= "1" && e.key <= "5") {
    const selected = steps[6].options[parseInt(e.key) - 1];
    currentValues.push(selected);
    let types = [];
    if (selected === "[도루]") types = [
      { key: "1", label: "[2루 도루 (2구 이내)]", color: "green" },
      { key: "2", label: "[2루 도루 (3구 이상)]", color: "green" },
      { key: "3", label: "[3루 도루]", color: "green" }
    ];
    if (selected === "[진루]") types = [
      { key: "1", label: "[2루 ETB]", color: "green" },
      { key: "2", label: "[3루 ETB]", color: "green" },
      { key: "3", label: "[홈 ETB]", color: "green" },
      { key: "4", label: "[상대 폭투로 진루]", color: "yellow" },
      { key: "5", label: "[상대 실책으로 진루]", color: "yellow" },
      { key: "6", label: "[진루타로 진루]", color: "yellow" }
    ];
    if (selected === "[아웃]") types = [
      { key: "1", label: "[도루자/주루사 (2루)]", color: "red" },
      { key: "2", label: "[도루자/주루사 (3루)]", color: "red" },
      { key: "3", label: "[도루자/주루사 (홈)]", color: "red" }
    ];
    if (selected === "[진루 기회 놓침]") types = [
      { key: "1", label: "[진루 기회 놓침 (2루/3루)]", color: "red" },
      { key: "2", label: "[진루 기회 놓침 (홈)]", color: "red" },
      { key: "3", label: "[도루 기회 놓침]", color: "red" }
    ];
    if (selected === "[주루 작전]") types = [
      { key: "1", label: "[주루 작전 성공]", color: "green" },
      { key: "2", label: "[주루 작전 실패]", color: "red" }
    ];
    steps[7].options = types;
    currentStep++;
    updateLegend(); updateCurrentInputLine(); updateStepProgress();
    return;
  }

  // 공통 숫자 입력 처리
  if (e.key >= "1" && e.key <= "9") {
    const index = parseInt(e.key) - 1;
    if (options && options[index]) {
      const val = options[index];
      currentValues.push(typeof val === "object" ? val.label : val);
      currentStep++;

      if (eventType === "[주루 이벤트]" && currentStep === 8) {
        writeRowAndReset();
        return;
      }
      if (currentStep === 9) {
        writeRowAndReset();
        return;
      }

      updateLegend(); updateCurrentInputLine(); updateStepProgress();
    }
  }

  // Backspace: 롤백
  if (e.key === "Backspace") {
    if (currentStep > 0) {
      currentStep--;
      currentValues.pop();
      updateLegend(); updateCurrentInputLine(); updateStepProgress();
    }
    e.preventDefault();
  }
});

function normalizePlayerKey(key) {
  if (!key) return key;
  const hangulToLatin = { "ㅂ":"q", "ㅈ":"w", "ㄷ":"e", "ㄱ":"r", "ㅅ":"t" };
  if (key.length === 1) {
    if (hangulToLatin[key]) return hangulToLatin[key];
    return key.toLowerCase();
  }
  return key;
}

/* ====== 로그 행 쓰기 & 리셋 ====== */
function writeRowAndReset() {
  const { code, score } = getCodeAndScore(currentValues);

  const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
  const row = tbody.insertRow(0);

  // 선택 체크박스
  const cbCell = row.insertCell(0);
  cbCell.innerHTML = '<input type="checkbox" class="rowSel">';

  // 고유번호
  row.insertCell(1).innerText = (++logSeq);

  // 이닝~결과
  for (let i = 0; i < steps.length; i++) {
    row.insertCell(i + 2).innerText = currentValues[i] || "-";
  }

  // 자연어 기록
  row.insertCell(steps.length + 2).innerText = buildRecord(currentValues);

  // 코드, 점수
  row.insertCell(steps.length + 3).innerText = code || "-";
  row.insertCell(steps.length + 4).innerText = (score !== "" ? score : "-");

  // reset
  currentStep = 0;
  currentValues = [];
  eventType = "";
  updateLegend(); updateCurrentInputLine(); updateStepProgress();
}

/* ====== 삭제/선택/CSV ====== */
function deleteSelectedRows() {
  const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
  const checked = Array.from(tbody.querySelectorAll('input.rowSel:checked'));
  if (checked.length === 0) return;
  checked.forEach(cb => {
    const tr = cb.closest('tr');
    if (tr && tr.parentNode === tbody) tbody.removeChild(tr);
  });
  const selectAll = document.getElementById('selectAll');
  if (selectAll) selectAll.checked = false;
}

function csvEscape(value) {
  const v = (value ?? "").toString();
  return `"${v.replace(/"/g, '""')}"`;
}
function tableToCSV() {
  const table = document.getElementById("logTable");
  const thead = table.tHead;
  const tbody = table.tBodies[0];

  const headerCells = Array.from(thead.rows[0].cells).slice(1); // 체크박스 제외
  const headers = headerCells.map(th => csvEscape(th.textContent.trim()));
  const rows = [headers.join(",")];

  Array.from(tbody.rows).forEach(tr => {
    const cells = Array.from(tr.cells).slice(1);
    const vals = cells.map(td => csvEscape(td.textContent.trim()));
    rows.push(vals.join(","));
  });

  return rows.join("\n");
}
function downloadCSV() {
  const csv = tableToCSV();
  const filename = (() => {
    const d = new Date();
    const pad = n => String(n).padStart(2, "0");
    return `eagles_logs_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.csv`;
  })();

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;

  if (typeof a.download === "undefined") {
    const dataUrl = "data:text/csv;charset=utf-8,\uFEFF" + encodeURIComponent(csv);
    window.open(dataUrl);
    return;
  }

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function setSelectAllBehavior() {
  const selectAll = document.getElementById('selectAll');
  const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
  if (!selectAll) return;

  selectAll.addEventListener('change', () => {
    const boxes = tbody.querySelectorAll('input.rowSel');
    boxes.forEach(b => b.checked = selectAll.checked);
  });

  document.getElementById('deleteSelected').addEventListener('click', deleteSelectedRows);
  const exportBtn = document.getElementById('exportCsv');
  if (exportBtn) exportBtn.addEventListener('click', downloadCSV);
}
</script>
</body>
</html>
